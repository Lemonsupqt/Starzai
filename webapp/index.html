<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StarzAI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #09090b;
      --bg-card: #18181b;
      --bg-card-hover: #1f1f23;
      --bg-surface: #111113;
      --text: #fafafa;
      --text-dim: #a1a1aa;
      --text-muted: #71717a;
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      --accent-glow: rgba(139, 92, 246, 0.25);
      --pink: #ec4899;
      --pink-glow: rgba(236, 72, 153, 0.2);
      --cyan: #22d3ee;
      --green: #34d399;
      --orange: #fb923c;
      --red: #f87171;
      --border: rgba(255,255,255,0.06);
      --border-accent: rgba(139, 92, 246, 0.2);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 8px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== AMBIENT BACKGROUND ===== */
    .ambient-bg {
      position: fixed; inset: 0; z-index: 0;
      pointer-events: none; overflow: hidden;
    }
    .ambient-bg .blob {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.12;
      animation: blobFloat 20s ease-in-out infinite;
    }
    .ambient-bg .blob-1 { width: 300px; height: 300px; background: var(--accent); top: -100px; right: -80px; }
    .ambient-bg .blob-2 { width: 250px; height: 250px; background: var(--pink); bottom: 20%; left: -60px; animation-delay: -7s; }
    .ambient-bg .blob-3 { width: 200px; height: 200px; background: var(--cyan); top: 40%; right: -40px; animation-delay: -14s; }
    @keyframes blobFloat {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(20px, -30px) scale(1.1); }
      50% { transform: translate(-15px, 20px) scale(0.95); }
      75% { transform: translate(10px, 15px) scale(1.05); }
    }

    /* ===== MAIN CONTAINER ===== */
    .app {
      position: relative; z-index: 1;
      max-width: 480px; margin: 0 auto;
      padding: 16px 16px 120px;
    }

    /* ===== HERO HEADER ===== */
    .hero { text-align: center; padding: 28px 0 8px; position: relative; }
    .hero-logo {
      width: 64px; height: 64px; border-radius: 20px;
      background: linear-gradient(135deg, var(--accent), var(--pink));
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 14px; font-size: 30px;
      box-shadow: 0 8px 32px var(--accent-glow), 0 0 0 1px rgba(139,92,246,0.15);
      animation: logoPulse 4s ease-in-out infinite;
    }
    @keyframes logoPulse {
      0%, 100% { box-shadow: 0 8px 32px var(--accent-glow), 0 0 0 1px rgba(139,92,246,0.15); }
      50% { box-shadow: 0 8px 48px rgba(139,92,246,0.35), 0 0 0 1px rgba(139,92,246,0.25); }
    }
    .hero h1 {
      font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
      background: linear-gradient(135deg, #fff 0%, #e4e4e7 50%, var(--accent-light) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .hero-sub { color: var(--text-muted); font-size: 13px; font-weight: 500; margin-top: 4px; }
    .hero-greeting {
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 12px; padding: 6px 14px;
      background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.12);
      border-radius: 20px; font-size: 12px; font-weight: 500; color: var(--accent-light);
    }

    /* ===== QUICK ACTIONS ===== */
    .quick-actions {
      display: flex; gap: 8px; margin: 20px 0;
      overflow-x: auto; scrollbar-width: none; padding: 2px 0;
    }
    .quick-actions::-webkit-scrollbar { display: none; }
    .quick-action {
      flex-shrink: 0; display: flex; align-items: center; gap: 6px;
      padding: 10px 16px; background: var(--bg-card);
      border: 1px solid var(--border); border-radius: 100px;
      color: var(--text); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s ease; white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .quick-action:active { transform: scale(0.96); }
    .quick-action:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }
    .quick-action .qa-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* ===== SECTION HEADERS ===== */
    .section-header { display: flex; align-items: center; justify-content: space-between; margin: 28px 0 14px; }
    .section-title {
      font-size: 17px; font-weight: 700; letter-spacing: -0.3px;
      display: flex; align-items: center; gap: 8px;
    }
    .section-title .st-icon {
      width: 28px; height: 28px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; font-size: 14px;
    }
    .section-badge {
      font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 100px;
      color: var(--accent-light); background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.15);
    }

    /* ===== AI MODES GRID ===== */
    .ai-modes-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .ai-mode {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px 14px; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden; -webkit-tap-highlight-color: transparent;
    }
    .ai-mode::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--mode-color, var(--accent)); opacity: 0; transition: opacity 0.25s ease;
    }
    .ai-mode:hover::before, .ai-mode.selected::before { opacity: 1; }
    .ai-mode:hover { border-color: rgba(255,255,255,0.1); background: var(--bg-card-hover); transform: translateY(-2px); }
    .ai-mode.selected { border-color: var(--mode-color, var(--accent)); background: color-mix(in srgb, var(--mode-color, var(--accent)) 8%, var(--bg-card)); }
    .ai-mode:active { transform: scale(0.97); }
    .ai-mode .mode-icon {
      width: 40px; height: 40px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; margin-bottom: 10px;
      background: color-mix(in srgb, var(--mode-color, var(--accent)) 12%, transparent);
    }
    .ai-mode .mode-name { font-size: 14px; font-weight: 700; margin-bottom: 3px; }
    .ai-mode .mode-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
    .ai-mode .mode-tag {
      display: inline-block; margin-top: 8px; font-size: 10px; font-weight: 600;
      padding: 2px 8px; border-radius: 6px; color: var(--mode-color, var(--accent));
      background: color-mix(in srgb, var(--mode-color, var(--accent)) 10%, transparent);
    }

    /* ===== INPUT AREA ===== */
    .input-area {
      margin-top: 16px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px; transition: border-color 0.2s ease;
    }
    .input-area:focus-within { border-color: var(--border-accent); }
    .input-mode-pill {
      display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px;
      background: rgba(139,92,246,0.1); border-radius: 8px; font-size: 12px;
      font-weight: 600; color: var(--accent-light); margin-bottom: 10px; transition: all 0.2s ease;
    }
    .input-area textarea {
      width: 100%; background: transparent; border: none; color: var(--text);
      font-size: 15px; font-family: inherit; resize: none; min-height: 80px; line-height: 1.5;
    }
    .input-area textarea:focus { outline: none; }
    .input-area textarea::placeholder { color: var(--text-muted); }

    /* ===== CHAT PANEL (AI Responses rendered in-app) ===== */
    .chat-panel {
      display: none;
      margin-top: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      animation: fadeIn 0.3s ease;
    }
    .chat-panel.active { display: block; }
    .chat-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px;
      background: rgba(139,92,246,0.06);
      border-bottom: 1px solid var(--border);
    }
    .chat-header-left {
      display: flex; align-items: center; gap: 8px;
    }
    .chat-header-mode {
      font-size: 13px; font-weight: 700; color: var(--accent-light);
    }
    .chat-header-model {
      font-size: 11px; color: var(--text-muted); font-weight: 500;
      padding: 2px 8px; background: rgba(255,255,255,0.04);
      border-radius: 6px;
    }
    .chat-close {
      width: 28px; height: 28px; border-radius: 8px;
      background: rgba(255,255,255,0.06); border: none; color: var(--text-muted);
      font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .chat-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }
    .chat-messages {
      padding: 16px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .chat-msg {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }
    .chat-msg-user {
      display: flex; justify-content: flex-end; margin-bottom: 12px;
    }
    .chat-msg-user .msg-bubble {
      max-width: 85%;
      padding: 10px 14px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border-radius: 16px 16px 4px 16px;
      font-size: 14px; line-height: 1.5; color: #fff;
    }
    .chat-msg-ai {
      margin-bottom: 12px;
    }
    .chat-msg-ai .msg-label {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      margin-bottom: 6px;
    }
    .chat-msg-ai .msg-label .ai-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
    }
    .chat-msg-ai .msg-content {
      font-size: 14px; line-height: 1.7; color: var(--text-dim);
    }
    /* Markdown rendered content styles */
    .chat-msg-ai .msg-content h1, .chat-msg-ai .msg-content h2, .chat-msg-ai .msg-content h3 {
      color: var(--text); margin: 16px 0 8px; font-weight: 700;
    }
    .chat-msg-ai .msg-content h1 { font-size: 18px; }
    .chat-msg-ai .msg-content h2 { font-size: 16px; }
    .chat-msg-ai .msg-content h3 { font-size: 15px; }
    .chat-msg-ai .msg-content p { margin-bottom: 10px; }
    .chat-msg-ai .msg-content strong { color: var(--text); font-weight: 600; }
    .chat-msg-ai .msg-content em { color: var(--accent-light); }
    .chat-msg-ai .msg-content ul, .chat-msg-ai .msg-content ol {
      padding-left: 20px; margin-bottom: 10px;
    }
    .chat-msg-ai .msg-content li { margin-bottom: 4px; }
    .chat-msg-ai .msg-content code {
      font-family: 'JetBrains Mono', monospace;
      background: rgba(139,92,246,0.1);
      padding: 2px 6px; border-radius: 4px;
      font-size: 13px; color: var(--accent-light);
    }
    .chat-msg-ai .msg-content pre {
      background: #0d0d0f;
      border: 1px solid var(--border);
      border-radius: var(--radius-xs);
      padding: 14px;
      overflow-x: auto;
      margin: 10px 0;
      position: relative;
    }
    .chat-msg-ai .msg-content pre code {
      background: none; padding: 0; border-radius: 0;
      font-size: 12.5px; color: var(--text-dim); line-height: 1.6;
      display: block; white-space: pre;
    }
    .chat-msg-ai .msg-content blockquote {
      border-left: 3px solid var(--accent);
      padding: 8px 14px; margin: 10px 0;
      background: rgba(139,92,246,0.05);
      border-radius: 0 8px 8px 0;
      color: var(--text-dim);
    }
    .chat-msg-ai .msg-content table {
      width: 100%; border-collapse: collapse; margin: 10px 0;
      font-size: 13px;
    }
    .chat-msg-ai .msg-content th, .chat-msg-ai .msg-content td {
      padding: 8px 10px; border: 1px solid var(--border); text-align: left;
    }
    .chat-msg-ai .msg-content th {
      background: rgba(139,92,246,0.08); color: var(--text); font-weight: 600;
    }
    .chat-msg-ai .msg-content a {
      color: var(--accent-light); text-decoration: underline;
    }

    /* Loading dots */
    .loading-dots {
      display: flex; gap: 4px; padding: 8px 0;
    }
    .loading-dots span {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent); opacity: 0.3;
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    /* ===== FEATURE CARDS ===== */
    .feature-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
    .feature-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px 10px; text-align: center; cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); -webkit-tap-highlight-color: transparent;
    }
    .feature-card:hover { border-color: rgba(255,255,255,0.1); background: var(--bg-card-hover); transform: translateY(-2px); }
    .feature-card:active { transform: scale(0.96); }
    .feature-card .fc-icon {
      width: 44px; height: 44px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; margin: 0 auto 8px;
      background: color-mix(in srgb, var(--fc-color, var(--accent)) 10%, transparent);
    }
    .feature-card .fc-name { font-size: 13px; font-weight: 700; }
    .feature-card .fc-desc { font-size: 10px; color: var(--text-muted); margin-top: 3px; }

    /* ===== FEATURE LIST ===== */
    .feature-list { display: flex; flex-direction: column; gap: 6px; }
    .feature-item {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); cursor: pointer; transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .feature-item:hover { background: var(--bg-card-hover); border-color: rgba(255,255,255,0.08); }
    .feature-item:active { transform: scale(0.98); }
    .feature-item .fi-icon { font-size: 22px; flex-shrink: 0; }
    .feature-item .fi-text { flex: 1; }
    .feature-item .fi-name { font-size: 14px; font-weight: 700; }
    .feature-item .fi-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .feature-item .fi-arrow { color: var(--text-muted); font-size: 20px; font-weight: 300; }

    /* ===== NEVERMORE GATEWAY ===== */
    .nevermore-gateway {
      margin-top: 28px; border-radius: var(--radius); overflow: hidden;
      background: linear-gradient(135deg, #1a0a2e 0%, #16082a 40%, #0f0720 100%);
      border: 1px solid rgba(139,92,246,0.15); cursor: pointer;
      transition: all 0.3s ease; position: relative;
    }
    .nevermore-gateway:hover { border-color: rgba(139,92,246,0.3); transform: translateY(-2px); }
    .nevermore-gateway:active { transform: scale(0.99); }
    .nev-bg { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .nev-orb {
      position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.15;
      animation: orbFloat 15s ease-in-out infinite;
    }
    .nev-orb-1 { width: 200px; height: 200px; background: #8b5cf6; top: -60px; right: -40px; }
    .nev-orb-2 { width: 150px; height: 150px; background: #ec4899; bottom: -40px; left: -30px; animation-delay: -5s; }
    @keyframes orbFloat {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(-20px, 15px); }
    }
    .nev-content { position: relative; z-index: 1; padding: 24px 20px; }
    .nev-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
    .nev-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 12px; border-radius: 100px;
      background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.2);
      font-size: 11px; font-weight: 600; color: #34d399;
    }
    .nev-dot { width: 6px; height: 6px; border-radius: 50%; background: #34d399; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .nev-arrow { color: rgba(255,255,255,0.3); font-size: 20px; }
    .nev-title { font-size: 13px; font-weight: 600; letter-spacing: 2.5px; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-bottom: 4px; }
    .nev-name {
      font-size: 28px; font-weight: 900; letter-spacing: -0.5px;
      background: linear-gradient(135deg, #c084fc, #f472b6, #a78bfa);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.1;
    }
    .nev-desc { color: #94a3b8; font-size: 12px; line-height: 1.5; margin-top: 8px; max-width: 280px; }
    .nev-features { display: flex; gap: 16px; margin-top: 18px; }
    .nev-feat { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #94a3b8; font-weight: 500; }
    .nev-feat-icon {
      width: 24px; height: 24px; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; background: rgba(139,92,246,0.1);
    }

    /* ===== UTILITIES SCROLL ===== */
    .utils-scroll {
      display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding: 2px 0;
    }
    .utils-scroll::-webkit-scrollbar { display: none; }
    .util-chip {
      flex-shrink: 0; display: flex; align-items: center; gap: 6px;
      padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .util-chip:hover { background: var(--bg-card-hover); border-color: rgba(255,255,255,0.08); }
    .util-chip:active { transform: scale(0.96); }
    .util-chip .uc-icon { font-size: 16px; }
    .util-chip .uc-name { font-size: 12px; font-weight: 600; white-space: nowrap; }

    /* ===== SUBMIT BUTTON ===== */
    .submit-btn {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: linear-gradient(to top, var(--bg) 60%, transparent);
    }
    .submit-btn button {
      width: 100%; max-width: 480px; margin: 0 auto; display: block;
      padding: 15px; border: none; border-radius: var(--radius);
      font-size: 15px; font-weight: 700; font-family: inherit; cursor: pointer;
      transition: all 0.25s ease;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff; box-shadow: 0 4px 20px var(--accent-glow); letter-spacing: 0.2px;
    }
    .submit-btn button:hover { transform: translateY(-1px); box-shadow: 0 8px 32px rgba(139,92,246,0.4); }
    .submit-btn button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
    .submit-btn button:active:not(:disabled) { transform: scale(0.98); }

    /* ===== FOOTER ===== */
    .footer { text-align: center; padding: 20px 0 8px; font-size: 11px; color: var(--text-muted); }
    .footer span { color: var(--accent-light); font-weight: 600; }

    /* ===== ANIMATIONS ===== */
    .fade-in { animation: fadeIn 0.4s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .stagger-1 { animation-delay: 0.05s; }
    .stagger-2 { animation-delay: 0.1s; }
    .stagger-3 { animation-delay: 0.15s; }
    .stagger-4 { animation-delay: 0.2s; }
    .stagger-5 { animation-delay: 0.25s; }
    .stagger-6 { animation-delay: 0.3s; }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    /* ===== COMMAND INPUT MODAL ===== */
    .cmd-modal-overlay {
      position: fixed; inset: 0; z-index: 300;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(6px);
      display: none; align-items: flex-end; justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    .cmd-modal-overlay.active { display: flex; }
    .cmd-modal {
      width: 100%; max-width: 480px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 20px 20px 0 0;
      padding: 20px 16px; padding-bottom: max(20px, env(safe-area-inset-bottom));
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .cmd-modal-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
    }
    .cmd-modal-title {
      display: flex; align-items: center; gap: 10px;
    }
    .cmd-modal-icon {
      width: 40px; height: 40px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center; font-size: 20px;
    }
    .cmd-modal-name { font-size: 16px; font-weight: 700; }
    .cmd-modal-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .cmd-modal-close {
      width: 32px; height: 32px; border-radius: 10px;
      background: rgba(255,255,255,0.06); border: none; color: var(--text-muted);
      font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .cmd-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }
    .cmd-modal-input {
      width: 100%; padding: 14px 16px;
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text);
      font-size: 15px; font-family: inherit; outline: none;
      transition: border-color 0.2s;
    }
    .cmd-modal-input:focus { border-color: var(--border-accent); }
    .cmd-modal-input::placeholder { color: var(--text-muted); }
    .cmd-modal-hint {
      font-size: 11px; color: var(--text-muted); margin-top: 8px;
      display: flex; align-items: center; gap: 4px;
    }
    .cmd-modal-send {
      width: 100%; margin-top: 14px; padding: 14px;
      border: none; border-radius: var(--radius-sm);
      font-size: 15px; font-weight: 700; font-family: inherit; cursor: pointer;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff; box-shadow: 0 4px 16px var(--accent-glow);
      transition: all 0.2s;
    }
    .cmd-modal-send:hover { transform: translateY(-1px); }
    .cmd-modal-send:active { transform: scale(0.98); }
    .cmd-modal-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .cmd-modal-sent {
      text-align: center; padding: 24px 0;
      animation: fadeIn 0.3s ease;
    }
    .cmd-modal-sent .sent-icon { font-size: 40px; margin-bottom: 8px; }
    .cmd-modal-sent .sent-text { font-size: 14px; font-weight: 600; color: var(--text); }
    .cmd-modal-sent .sent-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    /* ===== TOAST NOTIFICATION ===== */
    .toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 100px; font-size: 13px; font-weight: 600; color: var(--text);
      z-index: 200; opacity: 0; transition: opacity 0.3s ease;
      pointer-events: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

  <!-- Ambient Background -->
  <div class="ambient-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div class="app">

    <!-- ===== HERO ===== -->
    <div class="hero fade-in">
      <div class="hero-logo">&#10024;</div>
      <h1>StarzAI</h1>
      <p class="hero-sub">AI Assistant &bull; Image Studio &bull; Gaming Hub</p>
      <div class="hero-greeting" id="heroGreeting" style="display:none;">
        <span id="greetingText"></span>
      </div>
    </div>

    <!-- ===== QUICK ACTIONS ===== -->
    <div class="quick-actions fade-in stagger-1">
      <div class="quick-action" data-action="ask">
        <span class="qa-dot" style="background:var(--accent)"></span>
        Ask AI
      </div>
      <div class="quick-action" data-action="image">
        <span class="qa-dot" style="background:var(--pink)"></span>
        Generate Art
      </div>
      <div class="quick-action" data-action="music">
        <span class="qa-dot" style="background:var(--green)"></span>
        Find Music
      </div>
      <div class="quick-action" data-action="download">
        <span class="qa-dot" style="background:var(--cyan)"></span>
        Download
      </div>
      <div class="quick-action" data-action="nevermore">
        <span class="qa-dot" style="background:var(--orange)"></span>
        Play Games
      </div>
    </div>

    <!-- ===== AI MODES ===== -->
    <div class="section-header fade-in stagger-2">
      <div class="section-title">
        <div class="st-icon" style="background:rgba(139,92,246,0.12);">&#9889;</div>
        AI Modes
      </div>
      <div class="section-badge">8 modes</div>
    </div>

    <div class="ai-modes-grid fade-in stagger-2">
      <div class="ai-mode" data-mode="q:" data-name="Quark" style="--mode-color:#8b5cf6;">
        <div class="mode-icon" style="background:rgba(139,92,246,0.12);">&#11088;</div>
        <div class="mode-name">Quark</div>
        <div class="mode-desc">Lightning fast answers</div>
        <div class="mode-tag">q:</div>
      </div>
      <div class="ai-mode" data-mode="b:" data-name="Blackhole" style="--mode-color:#6366f1;">
        <div class="mode-icon" style="background:rgba(99,102,241,0.12);">&#128300;</div>
        <div class="mode-name">Blackhole</div>
        <div class="mode-desc">Deep research &amp; analysis</div>
        <div class="mode-tag">b:</div>
      </div>
      <div class="ai-mode" data-mode="code:" data-name="Code" style="--mode-color:#22d3ee;">
        <div class="mode-icon" style="background:rgba(34,211,238,0.12);">&#128187;</div>
        <div class="mode-name">Code</div>
        <div class="mode-desc">Programming help</div>
        <div class="mode-tag">code:</div>
      </div>
      <div class="ai-mode" data-mode="e:" data-name="Explain" style="--mode-color:#34d399;">
        <div class="mode-icon" style="background:rgba(52,211,153,0.12);">&#129504;</div>
        <div class="mode-name">Explain</div>
        <div class="mode-desc">Simple ELI5 explanations</div>
        <div class="mode-tag">e:</div>
      </div>
      <div class="ai-mode" data-mode="as " data-name="Character" style="--mode-color:#f472b6;">
        <div class="mode-icon" style="background:rgba(244,114,182,0.12);">&#127917;</div>
        <div class="mode-name">Character</div>
        <div class="mode-desc">Roleplay as anyone</div>
        <div class="mode-tag">as:</div>
      </div>
      <div class="ai-mode" data-mode="sum:" data-name="Summarize" style="--mode-color:#fb923c;">
        <div class="mode-icon" style="background:rgba(251,146,60,0.12);">&#128221;</div>
        <div class="mode-name">Summarize</div>
        <div class="mode-desc">Condense long text</div>
        <div class="mode-tag">sum:</div>
      </div>
      <div class="ai-mode" data-mode="p:" data-name="Partner" style="--mode-color:#ec4899;">
        <div class="mode-icon" style="background:rgba(236,72,153,0.12);">&#128156;</div>
        <div class="mode-name">Partner</div>
        <div class="mode-desc">AI companion with memory</div>
        <div class="mode-tag">p:</div>
      </div>
      <div class="ai-mode" data-mode="r:" data-name="Research" style="--mode-color:#a78bfa;">
        <div class="mode-icon" style="background:rgba(167,139,250,0.12);">&#128269;</div>
        <div class="mode-name">Research</div>
        <div class="mode-desc">Quick research</div>
        <div class="mode-tag">r:</div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area fade-in stagger-3" id="inputArea">
      <div class="input-mode-pill" id="modePill">Select a mode above</div>
      <textarea id="queryInput" placeholder="Type your question or topic here..." rows="3"></textarea>
    </div>

    <!-- ===== CHAT PANEL (AI responses rendered in-app) ===== -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-header">
        <div class="chat-header-left">
          <span class="chat-header-mode" id="chatMode">&#10024; StarzAI</span>
          <span class="chat-header-model" id="chatModel"></span>
        </div>
        <button class="chat-close" id="chatClose">&times;</button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
    </div>

    <!-- ===== IMAGE GENERATION ===== -->
    <div class="section-header fade-in stagger-3">
      <div class="section-title">
        <div class="st-icon" style="background:rgba(236,72,153,0.12);">&#127912;</div>
        Image Studio
      </div>
      <div class="section-badge">4 engines</div>
    </div>

    <div class="feature-row fade-in stagger-3">
      <div class="feature-card" data-cmd="/a" style="--fc-color:#ec4899;">
        <div class="fc-icon" style="background:rgba(236,72,153,0.1);">&#127912;</div>
        <div class="fc-name">Art Studio</div>
        <div class="fc-desc">SeedDream 4.5</div>
      </div>
      <div class="feature-card" data-cmd="/img" style="--fc-color:#8b5cf6;">
        <div class="fc-icon" style="background:rgba(139,92,246,0.1);">&#9889;</div>
        <div class="fc-name">Turbo Gen</div>
        <div class="fc-desc">Fast generation</div>
      </div>
      <div class="feature-card" data-cmd="/img2" style="--fc-color:#6366f1;">
        <div class="fc-icon" style="background:rgba(99,102,241,0.1);">&#10024;</div>
        <div class="fc-name">Flux</div>
        <div class="fc-desc">Alt style</div>
      </div>
    </div>
    <div class="feature-row fade-in stagger-3">
      <div class="feature-card" data-cmd="/imagine" style="--fc-color:#a78bfa;">
        <div class="fc-icon" style="background:rgba(167,139,250,0.1);">&#128444;</div>
        <div class="fc-name">Imagine</div>
        <div class="fc-desc">Free alt</div>
      </div>
      <div class="feature-card" data-cmd="/up" style="--fc-color:#34d399;">
        <div class="fc-icon" style="background:rgba(52,211,153,0.1);">&#128200;</div>
        <div class="fc-name">Upscaler</div>
        <div class="fc-desc">Enhance photos</div>
      </div>
      <div class="feature-card" data-cmd="/imgset" style="--fc-color:#71717a;">
        <div class="fc-icon" style="background:rgba(113,113,122,0.1);">&#9881;</div>
        <div class="fc-name">Settings</div>
        <div class="fc-desc">Ratio &amp; style</div>
      </div>
    </div>

    <!-- ===== MUSIC & MEDIA ===== -->
    <div class="section-header fade-in stagger-4">
      <div class="section-title">
        <div class="st-icon" style="background:rgba(52,211,153,0.12);">&#127925;</div>
        Music &amp; Media
      </div>
    </div>

    <div class="feature-list fade-in stagger-4">
      <div class="feature-item" data-cmd="/m" style="--fi-color:#34d399;">
        <div class="fi-icon">&#127925;</div>
        <div class="fi-text">
          <div class="fi-name">Music Search</div>
          <div class="fi-desc">Download songs in 320kbps</div>
        </div>
        <div class="fi-arrow">&#8250;</div>
      </div>
      <div class="feature-item" data-cmd="/lyrics" style="--fi-color:#a78bfa;">
        <div class="fi-icon">&#127908;</div>
        <div class="fi-text">
          <div class="fi-name">Lyrics</div>
          <div class="fi-desc">Synced lyrics for any song</div>
        </div>
        <div class="fi-arrow">&#8250;</div>
      </div>
      <div class="feature-item" data-cmd="/dl" style="--fi-color:#22d3ee;">
        <div class="fi-icon">&#128229;</div>
        <div class="fi-text">
          <div class="fi-name">Media Downloader</div>
          <div class="fi-desc">YouTube, TikTok, Instagram &amp; 20+ sites</div>
        </div>
        <div class="fi-arrow">&#8250;</div>
      </div>
      <div class="feature-item" data-cmd="/movie" style="--fi-color:#fb923c;">
        <div class="fi-icon">&#127916;</div>
        <div class="fi-text">
          <div class="fi-name">Movie &amp; TV Search</div>
          <div class="fi-desc">Browse movies and TV shows</div>
        </div>
        <div class="fi-arrow">&#8250;</div>
      </div>
      <div class="feature-item" data-cmd="/wallpaper" style="--fi-color:#f472b6;">
        <div class="fi-icon">&#128444;</div>
        <div class="fi-text">
          <div class="fi-name">Wallpapers</div>
          <div class="fi-desc">HD wallpaper search</div>
        </div>
        <div class="fi-arrow">&#8250;</div>
      </div>
    </div>

    <!-- ===== UTILITIES ===== -->
    <div class="section-header fade-in stagger-5">
      <div class="section-title">
        <div class="st-icon" style="background:rgba(34,211,238,0.12);">&#128736;</div>
        Utilities
      </div>
      <div class="section-badge">15+ tools</div>
    </div>

    <div class="utils-scroll fade-in stagger-5">
      <div class="util-chip" data-cmd="/qr"><span class="uc-icon">&#9641;</span><span class="uc-name">QR Code</span></div>
      <div class="util-chip" data-cmd="/weather"><span class="uc-icon">&#9925;</span><span class="uc-name">Weather</span></div>
      <div class="util-chip" data-cmd="/translate"><span class="uc-icon">&#127760;</span><span class="uc-name">Translate</span></div>
      <div class="util-chip" data-cmd="/currency"><span class="uc-icon">&#128177;</span><span class="uc-name">Currency</span></div>
      <div class="util-chip" data-cmd="/run"><span class="uc-icon">&#9654;</span><span class="uc-name">Run Code</span></div>
      <div class="util-chip" data-cmd="/wiki"><span class="uc-icon">&#128214;</span><span class="uc-name">Wiki</span></div>
      <div class="util-chip" data-cmd="/define"><span class="uc-icon">&#128218;</span><span class="uc-name">Dictionary</span></div>
      <div class="util-chip" data-cmd="/search"><span class="uc-icon">&#128270;</span><span class="uc-name">Web Search</span></div>
      <div class="util-chip" data-cmd="/short"><span class="uc-icon">&#128279;</span><span class="uc-name">URL Shortener</span></div>
      <div class="util-chip" data-cmd="/convert"><span class="uc-icon">&#128259;</span><span class="uc-name">Converter</span></div>
    </div>

    <!-- Second row of utilities -->
    <div class="utils-scroll fade-in stagger-5" style="margin-top:8px;">
      <div class="util-chip" data-cmd="/todo"><span class="uc-icon">&#128203;</span><span class="uc-name">Tasks</span></div>
      <div class="util-chip" data-cmd="/stats"><span class="uc-icon">&#128202;</span><span class="uc-name">Stats</span></div>
      <div class="util-chip" data-cmd="/fact"><span class="uc-icon">&#128161;</span><span class="uc-name">Facts</span></div>
      <div class="util-chip" data-cmd="/quote"><span class="uc-icon">&#128172;</span><span class="uc-name">Quotes</span></div>
      <div class="util-chip" data-cmd="/today"><span class="uc-icon">&#128197;</span><span class="uc-name">This Day</span></div>
      <div class="util-chip" data-cmd="/truth"><span class="uc-icon">&#128064;</span><span class="uc-name">Truth</span></div>
      <div class="util-chip" data-cmd="/dare"><span class="uc-icon">&#128293;</span><span class="uc-name">Dare</span></div>
      <div class="util-chip" data-cmd="/wyr"><span class="uc-icon">&#129300;</span><span class="uc-name">Would You Rather</span></div>
      <div class="util-chip" data-cmd="/roast"><span class="uc-icon">&#128520;</span><span class="uc-name">Roast</span></div>
    </div>

    <!-- ===== NEVERMORE GATEWAY ===== -->
    <div class="nevermore-gateway fade-in stagger-6" id="nevermoreGateway">
      <div class="nev-bg">
        <div class="nev-orb nev-orb-1"></div>
        <div class="nev-orb nev-orb-2"></div>
      </div>
      <div class="nev-content">
        <div class="nev-top">
          <div class="nev-badge">
            <span class="nev-dot"></span>
            Live &amp; Online
          </div>
          <div class="nev-arrow">&#8594;</div>
        </div>
        <div class="nev-title">Upside Down</div>
        <div class="nev-name">Nevermore</div>
        <p class="nev-desc">
          Real-time multiplayer games &mdash; Stranger Things &times; Wednesday themed. Chat with Wednesday AI.
        </p>
        <div class="nev-features">
          <div class="nev-feat"><div class="nev-feat-icon">&#127918;</div>Games</div>
          <div class="nev-feat"><div class="nev-feat-icon">&#128101;</div>Multiplayer</div>
          <div class="nev-feat"><div class="nev-feat-icon">&#127942;</div>Rankings</div>
          <div class="nev-feat"><div class="nev-feat-icon">&#129302;</div>Wednesday AI</div>
        </div>
      </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <div class="footer fade-in stagger-6">
      Powered by <span>StarzAI</span> &bull; 50+ features at your fingertips
    </div>

  </div>

  <!-- SUBMIT BUTTON -->
  <div class="submit-btn" id="submitBtnWrap">
    <button id="submitBtn" disabled>Select a mode to begin</button>
  </div>

  <!-- COMMAND INPUT MODAL -->
  <div class="cmd-modal-overlay" id="cmdModal">
    <div class="cmd-modal">
      <div class="cmd-modal-header">
        <div class="cmd-modal-title">
          <div class="cmd-modal-icon" id="cmdModalIcon"></div>
          <div>
            <div class="cmd-modal-name" id="cmdModalName"></div>
            <div class="cmd-modal-desc" id="cmdModalDesc"></div>
          </div>
        </div>
        <button class="cmd-modal-close" id="cmdModalClose">&times;</button>
      </div>
      <div id="cmdModalBody">
        <input type="text" class="cmd-modal-input" id="cmdModalInput" autocomplete="off" />
        <div class="cmd-modal-hint" id="cmdModalHint"></div>
        <button class="cmd-modal-send" id="cmdModalSend">Send</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script>
    // =====================
    // TELEGRAM WEBAPP INIT
    // =====================
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Configure marked for markdown rendering
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
      });
    }

    // Resolve API base URL (same origin as the webapp)
    const API_BASE = window.location.origin;

    // Personalized greeting
    const tgUser = tg.initDataUnsafe?.user;
    if (tgUser) {
      const name = tgUser.first_name || tgUser.username || 'there';
      const hour = new Date().getHours();
      let greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
      document.getElementById('greetingText').textContent = `${greeting}, ${name}`;
      document.getElementById('heroGreeting').style.display = 'inline-flex';
    }

    // =====================
    // TOAST NOTIFICATIONS
    // =====================
    function showToast(text, duration = 2500) {
      const toast = document.getElementById('toast');
      toast.textContent = text;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // =====================
    // AI MODE SELECTION
    // =====================
    let selectedMode = null;
    let selectedModeName = null;

    const modeCards = document.querySelectorAll('.ai-mode');
    const queryInput = document.getElementById('queryInput');
    const modePill = document.getElementById('modePill');
    const submitBtn = document.getElementById('submitBtn');
    const chatPanel = document.getElementById('chatPanel');
    const chatMessages = document.getElementById('chatMessages');
    const chatMode = document.getElementById('chatMode');
    const chatModel = document.getElementById('chatModel');

    const modeEmojis = {
      'q:': '&#11088;', 'b:': '&#128300;', 'code:': '&#128187;', 'e:': '&#129504;',
      'sum:': '&#128221;', 'r:': '&#128269;', 'p:': '&#128156;', 'as ': '&#127917;'
    };

    const placeholders = {
      'q:': 'Ask a quick question...',
      'b:': 'Enter a topic for deep analysis...',
      'code:': 'Describe your coding problem...',
      'e:': 'What would you like explained?',
      'as ': 'Enter character name (e.g., Yoda, Sherlock)...',
      'sum:': 'Paste text to summarize...',
      'p:': 'Send a message to your partner...',
      'r:': 'What would you like to research?'
    };

    modeCards.forEach(card => {
      card.addEventListener('click', () => {
        modeCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedMode = card.dataset.mode;
        selectedModeName = card.dataset.name;
        modePill.innerHTML = `&#10003; ${selectedModeName} mode`;
        modePill.style.background = 'rgba(139,92,246,0.15)';
        queryInput.placeholder = placeholders[selectedMode] || 'Type your query...';
        updateSubmitBtn();
        queryInput.focus();
        document.getElementById('inputArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    });

    queryInput.addEventListener('input', updateSubmitBtn);

    function updateSubmitBtn() {
      const hasMode = selectedMode !== null;
      const hasQuery = queryInput.value.trim().length > 0;
      submitBtn.disabled = !hasMode || !hasQuery;
      if (!hasMode) {
        submitBtn.textContent = 'Select a mode to begin';
      } else if (!hasQuery) {
        submitBtn.textContent = `Type your query for ${selectedModeName}`;
      } else {
        submitBtn.textContent = `Send with ${selectedModeName}`;
      }
    }

    // =====================
    // AI CHAT VIA BACKEND API (no Telegram text limits!)
    // =====================
    let isLoading = false;

    async function sendAIQuery() {
      if (!selectedMode || !queryInput.value.trim() || isLoading) return;

      const query = queryInput.value.trim();
      const mode = selectedMode;
      const modeName = selectedModeName;

      // Show chat panel
      chatPanel.classList.add('active');
      chatMode.innerHTML = `${modeEmojis[mode] || '&#10024;'} ${modeName}`;
      chatModel.textContent = 'loading...';

      // Add user message bubble
      const userMsgHTML = `
        <div class="chat-msg-user">
          <div class="msg-bubble">${escapeHTML(query)}</div>
        </div>
      `;
      chatMessages.innerHTML += userMsgHTML;

      // Add loading indicator
      const loadingId = 'loading-' + Date.now();
      chatMessages.innerHTML += `
        <div class="chat-msg-ai" id="${loadingId}">
          <div class="msg-label"><span class="ai-dot"></span> StarzAI is thinking...</div>
          <div class="loading-dots"><span></span><span></span><span></span></div>
        </div>
      `;

      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Clear input
      queryInput.value = '';
      updateSubmitBtn();
      isLoading = true;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating response...';

      try {
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: mode,
            query: query,
            userId: tgUser?.id || null,
            initData: tg.initData || ''
          })
        });

        const data = await response.json();

        // Remove loading indicator
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }

        // Update model badge
        chatModel.textContent = data.model || '';

        // Render AI response with full markdown
        let renderedHTML = '';
        if (typeof marked !== 'undefined' && marked.parse) {
          renderedHTML = marked.parse(data.response);
        } else {
          renderedHTML = `<p>${escapeHTML(data.response).replace(/\n/g, '<br>')}</p>`;
        }

        const aiMsgHTML = `
          <div class="chat-msg-ai">
            <div class="msg-label"><span class="ai-dot"></span> StarzAI &bull; ${escapeHTML(data.model || '')}</div>
            <div class="msg-content">${renderedHTML}</div>
          </div>
        `;
        chatMessages.innerHTML += aiMsgHTML;
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Scroll chat panel into view
        chatPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        // Remove loading indicator
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        chatMessages.innerHTML += `
          <div class="chat-msg-ai">
            <div class="msg-label"><span class="ai-dot" style="background:var(--red)"></span> Error</div>
            <div class="msg-content" style="color:var(--red);">${escapeHTML(err.message)}</div>
          </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } finally {
        isLoading = false;
        updateSubmitBtn();
      }
    }

    function escapeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Submit button -> AI chat
    submitBtn.addEventListener('click', sendAIQuery);

    // Telegram MainButton
    tg.MainButton.setText('Send Query');
    tg.MainButton.onClick(() => {
      if (!selectedMode || !queryInput.value.trim()) {
        tg.showAlert('Please select a mode and enter your query');
        return;
      }
      sendAIQuery();
    });

    // Close chat panel
    document.getElementById('chatClose').addEventListener('click', () => {
      chatPanel.classList.remove('active');
    });

    // =====================
    // QUICK ACTIONS
    // =====================
    document.querySelectorAll('.quick-action').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        if (action === 'ask') {
          document.querySelector('.ai-mode[data-mode="q:"]')?.click();
        } else if (action === 'image') {
          openCmdModal('/a');
        } else if (action === 'music') {
          openCmdModal('/m');
        } else if (action === 'download') {
          openCmdModal('/dl');
        } else if (action === 'nevermore') {
          openNevermore();
        }
      });
    });

    // =====================
    // COMMAND CONFIG (defines input requirements for each feature)
    // =====================
    const cmdConfig = {
      // Image Studio
      '/a':       { name: 'Art Studio', icon: '\ud83c\udfa8', desc: 'SeedDream 4.5', placeholder: 'Describe your image...', hint: 'e.g. a cute cat in space, cyberpunk style', color: '#ec4899', needsInput: true },
      '/img':     { name: 'Turbo Gen', icon: '\u26a1', desc: 'Fast image generation', placeholder: 'Describe your image...', hint: 'e.g. sunset over mountains, oil painting', color: '#8b5cf6', needsInput: true },
      '/img2':    { name: 'Flux', icon: '\u2728', desc: 'Alternative style engine', placeholder: 'Describe your image...', hint: 'e.g. portrait of a warrior, anime style', color: '#6366f1', needsInput: true },
      '/imagine': { name: 'Imagine', icon: '\ud83d\uddbc\ufe0f', desc: 'Free alternative', placeholder: 'Describe your image...', hint: 'e.g. dragon flying over a castle', color: '#a78bfa', needsInput: true },
      '/up':      { name: 'Upscaler', icon: '\ud83d\udd0d', desc: 'Reply to a photo in chat with /up', placeholder: '', hint: '', color: '#34d399', needsInput: false, instantMsg: 'Reply to any photo in chat with /up to upscale it!' },
      '/imgset':  { name: 'Image Settings', icon: '\u2699\ufe0f', desc: 'Opens settings in chat', placeholder: '', hint: '', color: '#71717a', needsInput: false },
      // Music & Media
      '/m':       { name: 'Music Search', icon: '\ud83c\udfb5', desc: 'Download in 320kbps', placeholder: 'Enter song name or artist...', hint: 'e.g. Shape of You, Bohemian Rhapsody', color: '#34d399', needsInput: true },
      '/lyrics':  { name: 'Lyrics', icon: '\ud83c\udfa4', desc: 'Synced lyrics', placeholder: 'Enter song name...', hint: 'e.g. Ed Sheeran - Shape of You', color: '#a78bfa', needsInput: true },
      '/dl':      { name: 'Media Downloader', icon: '\ud83d\udce5', desc: 'YouTube, TikTok, Instagram & more', placeholder: 'Paste URL here...', hint: 'Supports YouTube, TikTok, Instagram, Twitter & 20+ sites', color: '#22d3ee', needsInput: true },
      '/movie':   { name: 'Movie Search', icon: '\ud83c\udfac', desc: 'Browse movies', placeholder: 'Enter movie title...', hint: 'e.g. Inception, The Dark Knight', color: '#fb923c', needsInput: true },
      '/tv':      { name: 'TV Show Search', icon: '\ud83d\udcfa', desc: 'Browse TV shows', placeholder: 'Enter TV show title...', hint: 'e.g. Breaking Bad, Wednesday', color: '#fb923c', needsInput: true },
      '/wallpaper': { name: 'Wallpapers', icon: '\ud83d\uddbc\ufe0f', desc: 'HD wallpaper search', placeholder: 'Search wallpapers...', hint: 'e.g. nature, anime, dark aesthetic', color: '#f472b6', needsInput: true },
      // Utilities with input
      '/qr':       { name: 'QR Code', icon: '\u25ab\ufe0f', desc: 'Generate QR codes', placeholder: 'Enter text or URL...', hint: 'e.g. https://example.com', color: '#8b5cf6', needsInput: true },
      '/weather':  { name: 'Weather', icon: '\u26c5', desc: 'Weather forecast', placeholder: 'Enter city name...', hint: 'e.g. Tokyo, London, New York', color: '#22d3ee', needsInput: true },
      '/translate':{ name: 'Translate', icon: '\ud83c\udf10', desc: 'Translate text', placeholder: 'Enter text to translate...', hint: 'Format: to:es Hello world (language code)', color: '#34d399', needsInput: true },
      '/currency': { name: 'Currency', icon: '\ud83d\udcb1', desc: 'Convert currencies', placeholder: 'e.g. 100 USD EUR', hint: 'Format: amount FROM TO', color: '#fb923c', needsInput: true },
      '/run':      { name: 'Run Code', icon: '\u25b6\ufe0f', desc: 'Execute code', placeholder: 'Enter code to run...', hint: 'Format: language\ncode (e.g. python\nprint("hello"))', color: '#22d3ee', needsInput: true, useTextarea: true },
      '/wiki':     { name: 'Wikipedia', icon: '\ud83d\udcd6', desc: 'Search Wikipedia', placeholder: 'Search topic...', hint: 'e.g. quantum physics, Albert Einstein', color: '#a78bfa', needsInput: true },
      '/define':   { name: 'Dictionary', icon: '\ud83d\udcda', desc: 'Word definitions', placeholder: 'Enter a word...', hint: 'e.g. serendipity, ephemeral', color: '#6366f1', needsInput: true },
      '/search':   { name: 'Web Search', icon: '\ud83d\udd0e', desc: 'Search the web', placeholder: 'What are you looking for?', hint: 'Uses your daily web search quota', color: '#8b5cf6', needsInput: true },
      '/short':    { name: 'URL Shortener', icon: '\ud83d\udd17', desc: 'Shorten links', placeholder: 'Paste URL to shorten...', hint: 'e.g. https://very-long-url.com/path', color: '#34d399', needsInput: true },
      '/convert':  { name: 'Unit Converter', icon: '\ud83d\udd03', desc: 'Convert units', placeholder: 'e.g. 10 kg lbs', hint: 'Format: value FROM TO', color: '#22d3ee', needsInput: true },
      // Instant commands (no input needed)
      '/todo':   { name: 'Tasks', icon: '\ud83d\udccb', desc: 'View your task list', needsInput: false },
      '/stats':  { name: 'Stats', icon: '\ud83d\udcca', desc: 'Your usage statistics', needsInput: false },
      '/fact':   { name: 'Random Fact', icon: '\ud83d\udca1', desc: 'Get a fun fact', needsInput: false },
      '/quote':  { name: 'Quote', icon: '\ud83d\udcac', desc: 'Inspirational quote', needsInput: false },
      '/today':  { name: 'This Day', icon: '\ud83d\udcc5', desc: 'Today in history', needsInput: false },
      '/truth':  { name: 'Truth', icon: '\ud83d\udc40', desc: 'Truth question', needsInput: false },
      '/dare':   { name: 'Dare', icon: '\ud83d\udd25', desc: 'Dare challenge', needsInput: false },
      '/wyr':    { name: 'Would You Rather', icon: '\ud83e\udd14', desc: 'WYR question', needsInput: false },
      '/roast':  { name: 'Roast', icon: '\ud83d\ude08', desc: 'Get roasted', needsInput: false },
    };

    // =====================
    // COMMAND MODAL LOGIC
    // =====================
    const cmdModal = document.getElementById('cmdModal');
    const cmdModalIcon = document.getElementById('cmdModalIcon');
    const cmdModalName = document.getElementById('cmdModalName');
    const cmdModalDesc = document.getElementById('cmdModalDesc');
    const cmdModalBody = document.getElementById('cmdModalBody');
    const cmdModalInput = document.getElementById('cmdModalInput');
    const cmdModalHint = document.getElementById('cmdModalHint');
    const cmdModalSend = document.getElementById('cmdModalSend');
    const cmdModalClose = document.getElementById('cmdModalClose');
    let currentCmd = null;

    function openCmdModal(cmd) {
      const cfg = cmdConfig[cmd];
      if (!cfg) return;
      currentCmd = cmd;

      // If no input needed, send immediately
      if (!cfg.needsInput) {
        if (cfg.instantMsg) {
          showToast(cfg.instantMsg, 3000);
          return;
        }
        sendCommandToBot(cmd, '');
        return;
      }

      // Configure modal
      cmdModalIcon.textContent = cfg.icon;
      cmdModalIcon.style.background = `color-mix(in srgb, ${cfg.color || 'var(--accent)'} 15%, transparent)`;
      cmdModalName.textContent = cfg.name;
      cmdModalDesc.textContent = cfg.desc;
      cmdModalInput.placeholder = cfg.placeholder || 'Enter your input...';
      cmdModalHint.textContent = cfg.hint || '';
      cmdModalSend.textContent = `Send to ${cfg.name}`;
      cmdModalSend.disabled = true;
      cmdModalInput.value = '';

      // Reset body to input mode
      cmdModalBody.innerHTML = '';
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'cmd-modal-input';
      input.id = 'cmdModalInput';
      input.autocomplete = 'off';
      input.placeholder = cfg.placeholder || 'Enter your input...';
      cmdModalBody.appendChild(input);

      if (cfg.hint) {
        const hint = document.createElement('div');
        hint.className = 'cmd-modal-hint';
        hint.textContent = cfg.hint;
        cmdModalBody.appendChild(hint);
      }

      const sendBtn = document.createElement('button');
      sendBtn.className = 'cmd-modal-send';
      sendBtn.id = 'cmdModalSend';
      sendBtn.textContent = `Send to ${cfg.name}`;
      sendBtn.disabled = true;
      cmdModalBody.appendChild(sendBtn);

      // Wire up events
      input.addEventListener('input', () => {
        sendBtn.disabled = !input.value.trim();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          sendBtn.click();
        }
      });
      sendBtn.addEventListener('click', () => {
        if (!input.value.trim()) return;
        sendCommandToBot(currentCmd, input.value.trim());
      });

      // Show modal
      cmdModal.classList.add('active');
      setTimeout(() => input.focus(), 100);
    }

    function closeCmdModal() {
      cmdModal.classList.remove('active');
      currentCmd = null;
    }

    function sendCommandToBot(cmd, args) {
      try {
        tg.sendData(JSON.stringify({ command: cmd, args: args, action: 'execute' }));
        // Show sent confirmation
        cmdModalBody.innerHTML = `
          <div class="cmd-modal-sent">
            <div class="sent-icon">\u2705</div>
            <div class="sent-text">Sent to StarzAI!</div>
            <div class="sent-sub">Check your chat for the result</div>
          </div>
        `;
        setTimeout(() => closeCmdModal(), 1500);
      } catch (e) {
        const fullCmd = args ? `${cmd} ${args}` : cmd;
        showToast(`Use ${fullCmd} in chat`, 3000);
        closeCmdModal();
      }
    }

    // Close modal on overlay click or close button
    cmdModalClose.addEventListener('click', closeCmdModal);
    cmdModal.addEventListener('click', (e) => {
      if (e.target === cmdModal) closeCmdModal();
    });

    // =====================
    // FEATURE CARDS & ITEMS -> COMMAND MODAL
    // =====================
    document.querySelectorAll('.feature-card, .feature-item, .util-chip').forEach(el => {
      el.addEventListener('click', () => {
        const cmd = el.dataset.cmd;
        if (cmd) openCmdModal(cmd);
      });
    });

    function sendCommand(cmd) {
      openCmdModal(cmd);
    }

    // =====================
    // NEVERMORE GATEWAY (with Telegram auto-login)
    // =====================
    const NEVERMORE_BASE = 'https://wednesday-addams-production.up.railway.app/';

    function buildNevermoreURL() {
      const user = tg.initDataUnsafe?.user;
      if (user && user.id) {
        const params = new URLSearchParams();
        params.set('tg_id', String(user.id));
        const displayName = [user.first_name, user.last_name].filter(Boolean).join(' ')
          || user.username || 'Telegram User';
        params.set('tg_name', displayName);
        return NEVERMORE_BASE + '?' + params.toString();
      }
      return NEVERMORE_BASE;
    }

    function openNevermore() {
      const url = buildNevermoreURL();
      if (tg.openLink) {
        tg.openLink(url);
      } else {
        window.open(url, '_blank');
      }
    }

    document.getElementById('nevermoreGateway').addEventListener('click', openNevermore);

    // =====================
    // DEEP LINK SUPPORT
    // =====================
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'nevermore') {
      document.getElementById('nevermoreGateway').scrollIntoView({ behavior: 'smooth' });
    }

    // =====================
    // INTERSECTION OBSERVER (fade-in on scroll)
    // =====================
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.fade-in').forEach(el => {
      observer.observe(el);
    });

    // Enter key to submit
    queryInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!submitBtn.disabled) sendAIQuery();
      }
    });
  </script>
</body>
</html>
